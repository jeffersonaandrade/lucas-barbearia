// Configura√ß√£o da API
const API_BASE_URL = import.meta.env.VITE_API_URL || 'http://localhost:3000/api';

// Classe para gerenciar requisi√ß√µes HTTP
class ApiService {
  constructor() {
    this.baseURL = API_BASE_URL;
    this.token = sessionStorage.getItem('adminToken');
  }

  // Configurar headers padr√£o
  getHeaders() {
    const headers = {
      'Content-Type': 'application/json',
    };

    // Sempre verificar o token atual no sessionStorage
    const currentToken = sessionStorage.getItem('adminToken');
    if (currentToken) {
      this.token = currentToken; // Atualizar token interno se necess√°rio
      headers['Authorization'] = `Bearer ${currentToken}`;
    } else if (this.token) {
      headers['Authorization'] = `Bearer ${this.token}`;
    }

    return headers;
  }

  // Atualizar token
  setToken(token) {
    this.token = token;
  }

  // M√©todo gen√©rico para requisi√ß√µes
  async request(endpoint, options = {}) {
    const url = `${this.baseURL}${endpoint}`;
    
    const config = {
      headers: this.getHeaders(),
      ...options,
    };

    // Debug: verificar se o token est√° sendo enviado
    const authHeader = config.headers['Authorization'];
    console.log(`üîê API Request to ${endpoint}:`, {
      url,
      hasToken: !!authHeader,
      tokenPreview: authHeader ? `${authHeader.substring(0, 20)}...` : 'No token'
    });

    try {
      const response = await fetch(url, config);
      
      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
      }

      return await response.json();
    } catch (error) {
      console.error(`API Error (${endpoint}):`, error);
      throw error;
    }
  }

  // M√©todo para endpoints p√∫blicos (sem autentica√ß√£o)
  async publicRequest(endpoint, options = {}) {
    const url = `${this.baseURL}${endpoint}`;
    
    const config = {
      headers: {
        'Content-Type': 'application/json',
      },
      ...options,
    };

    console.log('üåê publicRequest URL:', url);
    console.log('‚öôÔ∏è publicRequest config:', config);

    try {
      const response = await fetch(url, config);
      console.log('üì° Response status:', response.status);
      console.log('üì° Response ok:', response.ok);
      
      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        console.error('‚ùå HTTP Error:', errorData);
        throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
      }

      const jsonResponse = await response.json();
      console.log('üì¶ publicRequest JSON response:', jsonResponse);
      return jsonResponse;
    } catch (error) {
      console.error(`API Error (${endpoint}):`, error);
      throw error;
    }
  }

  // GET request
  async get(endpoint) {
    return this.request(endpoint, { method: 'GET' });
  }

  // GET request p√∫blico (sem autentica√ß√£o)
  async publicGet(endpoint) {
    return this.publicRequest(endpoint, { method: 'GET' });
  }

  // POST request
  async post(endpoint, data) {
    return this.request(endpoint, {
      method: 'POST',
      body: JSON.stringify(data),
    });
  }

  // POST request p√∫blico (sem autentica√ß√£o)
  async publicPost(endpoint, data) {
    console.log('üì§ publicPost chamado:', endpoint, data);
    try {
      const response = await this.publicRequest(endpoint, {
        method: 'POST',
        body: JSON.stringify(data),
      });
      console.log('üì¶ publicPost response:', response);
      return response;
    } catch (error) {
      console.error('‚ùå publicPost error:', error);
      throw error;
    }
  }

  // PUT request
  async put(endpoint, data) {
    return this.request(endpoint, {
      method: 'PUT',
      body: JSON.stringify(data),
    });
  }

  // DELETE request
  async delete(endpoint) {
    return this.request(endpoint, { method: 'DELETE' });
  }
}

// Inst√¢ncia global da API
const api = new ApiService();

// Servi√ßos espec√≠ficos
export const authService = {
  // Login
  async login(email, password) {
    const response = await api.post('/auth/login', { email, password });
    
    // O backend retorna { success, message, data: { user, token } }
    if (response.data && response.data.token) {
      api.setToken(response.data.token);
      sessionStorage.setItem('adminToken', response.data.token);
      sessionStorage.setItem('userRole', response.data.user.role);
      sessionStorage.setItem('userEmail', response.data.user.email);
      
      // Retornar no formato esperado pelo frontend
      return {
        success: response.success,
        message: response.message,
        user: response.data.user,
        token: response.data.token
      };
    }
    
    return response;
  },

  // Logout
  async logout() {
    try {
      await api.post('/auth/logout');
    } catch (error) {
      console.warn('Erro no logout do servidor:', error);
    } finally {
      api.setToken(null);
      sessionStorage.removeItem('adminToken');
      sessionStorage.removeItem('userRole');
      sessionStorage.removeItem('userEmail');
    }
  },

  // Verificar usu√°rio atual
  async getCurrentUser() {
    return api.get('/auth/me');
  },
};

export const barbeariasService = {
  // Listar todas as barbearias (P√öBLICO)
  async listarBarbearias() {
    return api.publicGet('/barbearias');
  },

  // Obter barbearia espec√≠fica (P√öBLICO)
  async obterBarbearia(id) {
    return api.publicGet(`/barbearias/${id}`);
  },

  // Criar barbearia (ADMIN)
  async criarBarbearia(data) {
    return api.post('/barbearias', data);
  },

  // Atualizar barbearia (ADMIN)
  async atualizarBarbearia(id, data) {
    return api.put(`/barbearias/${id}`, data);
  },

  // Remover barbearia (ADMIN)
  async removerBarbearia(id) {
    return api.delete(`/barbearias/${id}`);
  },

  // Verificar status da barbearia (P√öBLICO)
  async verificarStatus(barbeariaId) {
    console.log('üîç Verificando status da barbearia:', barbeariaId);
    return api.publicGet(`/barbearias/${barbeariaId}/status`);
  },

  // Listar barbeiros (P√öBLICO - para clientes escolherem)
  async listarBarbeirosPublicos(barbeariaId) {
    const params = new URLSearchParams();
    params.append('status', 'ativo');
    params.append('public', 'true');
    params.append('barbearia_id', barbeariaId);
    
    const queryString = params.toString();
    const endpoint = `/users/barbeiros?${queryString}`;
    
    console.log('üîó Chamando endpoint de barbeiros p√∫blicos:', endpoint);
    
    try {
      const response = await api.publicGet(endpoint);
      console.log('üì¶ Resposta bruta da API de barbeiros:', response);
      console.log('üîç Estrutura da resposta:', {
        hasData: !!response?.data,
        hasBarbeiros: !!response?.data?.barbeiros,
        hasBarbeirosDirect: !!response?.barbeiros,
        isArray: Array.isArray(response),
        isDataArray: Array.isArray(response?.data)
      });
      return response;
    } catch (error) {
      console.error('‚ùå Erro ao buscar barbeiros:', error);
      throw error;
    }
  },

  // Listar barbeiros ativos (P√öBLICO - para valida√ß√£o de disponibilidade)
  async listarBarbeirosAtivos(barbeariaId = null) {
    const params = new URLSearchParams();
    params.append('status', 'ativo');
    params.append('public', 'true');
    
    if (barbeariaId) {
      params.append('barbearia_id', barbeariaId);
    }
    
    const queryString = params.toString();
    const endpoint = `/users/barbeiros?${queryString}`;
    
    return api.publicGet(endpoint);
  }
};

export const filaService = {
  // Cliente entra na fila (SEM autentica√ß√£o)
  async entrarNaFila(dadosCliente) {
    return api.publicPost(`/fila/entrar`, dadosCliente);
  },

  // Cliente entra na fila (LEGACY - manter compatibilidade)
  async entrarNaFilaLegacy(barbeariaId, dadosCliente) {
    return api.publicPost(`/fila/entrar`, {
      ...dadosCliente,
      barbearia_id: barbeariaId
    });
  },

  // Obter fila completa (BARBEIRO)
  async obterFilaCompleta(barbeariaId) {
    return api.get(`/fila/${barbeariaId}`);
  },

  // Obter fila p√∫blica (CLIENTES)
  async obterFilaPublica(barbeariaId) {
    return api.publicGet(`/fila-publica/${barbeariaId}`);
  },

  // Obter status do cliente (SEM autentica√ß√£o)
  async obterStatusCliente(token, barbeariaId = null) {
    // Se n√£o tem barbeariaId, tentar pegar do localStorage
    if (!barbeariaId) {
      barbeariaId = localStorage.getItem('fila_barbearia_id');
    }
    
    if (!barbeariaId) {
      throw new Error('Barbearia ID n√£o encontrado');
    }
    
    return api.publicGet(`/fila/${barbeariaId}/status/${token}`);
  },

  // Cliente sair da fila (SEM autentica√ß√£o) - N√ÉO IMPLEMENTADO NO BACKEND
  async sairDaFila(barbeariaId, token) {
    console.warn('Endpoint DELETE /fila/:barbeariaId/sair/:token n√£o implementado no backend');
    throw new Error('Funcionalidade de sair da fila n√£o implementada no backend');
  },

  // Chamar pr√≥ximo cliente (BARBEIRO)
  async chamarProximo(barbeariaId) {
    return api.post(`/fila/proximo/${barbeariaId}`);
  },

  // Iniciar atendimento (BARBEIRO)
  async iniciarAtendimento(clienteId) {
    return api.post(`/fila/iniciar-atendimento/${clienteId}`);
  },

  // Finalizar atendimento (BARBEIRO)
  async finalizarAtendimento(clienteId) {
    return api.post(`/fila/finalizar-atendimento/${clienteId}`);
  },

  // Remover cliente da fila (BARBEIRO)
  async removerCliente(clienteId) {
    return api.post(`/fila/remover/${clienteId}`);
  },

  // Remover cliente da fila (ADMIN)
  async removerClienteAdmin(clienteId) {
    // Enviar POST com body vazio para evitar erro do Fastify
    return api.post(`/fila/admin/remover/${clienteId}`, {});
  },

  // Buscar estat√≠sticas da fila
  async getEstatisticas(barbeariaId) {
    return api.get(`/fila/${barbeariaId}/estatisticas`);
  },

  // Adicionar cliente manualmente (BARBEIRO)
  async adicionarClienteManual(barbeariaId, dadosCliente) {
    return api.publicPost(`/fila/entrar`, {
      ...dadosCliente,
      barbearia_id: barbeariaId
    });
  }
};




export const usuariosService = {
  // Listar usu√°rios (admin)
  async listarUsuarios(filtros = {}) {
    const params = new URLSearchParams();
    
    // Par√¢metros suportados
    if (filtros.role) params.append('role', filtros.role);
    if (filtros.ativo) params.append('ativo', filtros.ativo);
    if (filtros.page) params.append('page', filtros.page);
    if (filtros.limit) params.append('limit', filtros.limit);
    
    const queryString = params.toString();
    const endpoint = queryString ? `/users?${queryString}` : '/users';
    
    return api.get(endpoint);
  },

  // Criar usu√°rio (admin)
  async criarUsuario(dadosUsuario) {
    return api.post('/users', dadosUsuario);
  },

  // Atualizar usu√°rio (admin)
  async atualizarUsuario(id, dadosUsuario) {
    return api.put(`/users/${id}`, dadosUsuario);
  },

  // Remover usu√°rio (admin)
  async removerUsuario(id) {
    return api.delete(`/users/${id}`);
  },

  // Atualizar status do barbeiro (ativar/desativar)
  async atualizarStatusBarbeiro(acao, dados) {
    const payload = {
      barbearia_id: dados.barbearia_id,
      ativo: acao === 'ativar'
    };
    
    return api.post('/users/barbeiros/alterar-status', payload);
  },

  // Obter status do barbeiro atual
  async obterStatusBarbeiro() {
    return api.get('/users/barbeiros/meu-status');
  }
};

export const avaliacoesService = {
  // Enviar avalia√ß√£o (P√öBLICO)
  async enviarAvaliacao(dadosAvaliacao) {
    return api.publicPost('/avaliacoes', dadosAvaliacao);
  },

  // Listar avalia√ß√µes (com filtros) - ADMIN/GERENTE
  async listarAvaliacoes(filtros = {}) {
    const params = new URLSearchParams();
    
    // Par√¢metros suportados
    if (filtros.barbearia_id) params.append('barbearia_id', filtros.barbearia_id);
    if (filtros.barbeiro_id) params.append('barbeiro_id', filtros.barbeiro_id);
    if (filtros.page) params.append('page', filtros.page);
    if (filtros.limit) params.append('limit', filtros.limit);
    if (filtros.rating) params.append('rating', filtros.rating);
    
    const queryString = params.toString();
    const endpoint = queryString ? `/avaliacoes?${queryString}` : '/avaliacoes';
    
    return api.get(endpoint);
  }
};

export const historicoService = {
  // Obter hist√≥rico (com filtros) - ADMIN/GERENTE
  async obterHistorico(filtros = {}) {
    const params = new URLSearchParams();
    
    // Par√¢metros suportados
    if (filtros.data_inicio) params.append('data_inicio', filtros.data_inicio);
    if (filtros.data_fim) params.append('data_fim', filtros.data_fim);
    if (filtros.barbearia_id) params.append('barbearia_id', filtros.barbearia_id);
    if (filtros.barbeiro_id) params.append('barbeiro_id', filtros.barbeiro_id);
    if (filtros.page) params.append('page', filtros.page);
    if (filtros.limit) params.append('limit', filtros.limit);
    
    const queryString = params.toString();
    const endpoint = queryString ? `/historico?${queryString}` : '/historico';
    
    return api.get(endpoint);
  },

  // Obter relat√≥rios (com filtros) - ADMIN/GERENTE
  async obterRelatorios(filtros = {}) {
    const params = new URLSearchParams();
    
    // Par√¢metros suportados
    if (filtros.data_inicio) params.append('data_inicio', filtros.data_inicio);
    if (filtros.data_fim) params.append('data_fim', filtros.data_fim);
    if (filtros.barbearia_id) params.append('barbearia_id', filtros.barbearia_id);
    if (filtros.barbeiro_id) params.append('barbeiro_id', filtros.barbeiro_id);
    if (filtros.tipo) params.append('tipo', filtros.tipo);
    if (filtros.page) params.append('page', filtros.page);
    if (filtros.limit) params.append('limit', filtros.limit);
    
    const queryString = params.toString();
    const endpoint = queryString ? `/historico/relatorios?${queryString}` : '/historico/relatorios';
    
    return api.get(endpoint);
  }
};

// Servi√ßos utilit√°rios centralizados
export const utilsService = {
  // Verificar sa√∫de da API
  async checkHealth() {
    return api.publicGet('/health');
  }
};

// Servi√ßo de desenvolvimento (bypass)
export const devService = {
  // Entrar na fila diretamente (para testes)
  async enterQueueDirectly(barbeariaId, dadosCliente) {
    return api.publicPost('/fila/entrar', {
      nome: dadosCliente.nome,
      telefone: dadosCliente.telefone,
      barbearia_id: barbeariaId,
      barbeiro_id: dadosCliente.barbeiro === 'Fila Geral' ? null : dadosCliente.barbeiro
    });
  }
};

// Exportar inst√¢ncia da API para uso direto
export { api };

// Fun√ß√£o para configurar interceptors (opcional)
export const setupApiInterceptors = () => {
  // Aqui voc√™ pode adicionar interceptors para tratamento global de erros
  // Por exemplo, refresh token autom√°tico, redirecionamento em caso de 401, etc.
};

export default api; 